from PyQt5.QtWidgets import QApplication, QWidget, QPushButton, QLabel, QListWidget, QFileDialog
from PyQt5.QtWidgets import QHBoxLayout, QVBoxLayout
from PyQt5.QtGui import QPixmap
from PyQt5.QtCore import Qt
from PIL import Image, ImageFilter, ImageOps
import os
import sys

app = QApplication([])
win = QWidget()

btn_dir = QPushButton('Папка')
btn_left = QPushButton('Влево')
btn_right = QPushButton('Вправо')
btn_flip = QPushButton('Отразить')
btn_sharp = QPushButton('Резкость')
btn_bw = QPushButton('Ч/Б')

lw_files = QListWidget()
lb_image = QLabel()

row = QHBoxLayout()
col1 = QVBoxLayout()
col2 = QVBoxLayout()

col1.addWidget(btn_dir)
col1.addWidget(lw_files)

col2.addWidget(lb_image)

row_tools = QHBoxLayout()
row_tools.addWidget(btn_left)
row_tools.addWidget(btn_right)
row_tools.addWidget(btn_flip)
row_tools.addWidget(btn_sharp)
row_tools.addWidget(btn_bw)

col2.addLayout(row_tools)

row.addLayout(col1, 20)
row.addLayout(col2, 80)

win.setLayout(row)
win.show()

workdir = ''


def filter(files, extensions):
    result = []
    for filename in files:
        for ext in extensions:
            if filename.endswith(ext):
                result.append(filename)
    return result


def chooseWorkdir():
    global workdir
    workdir = QFileDialog.getExistingDirectory()


def showFilenamesList():
    chooseWorkdir()
    extensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp']
    filenames = filter(os.listdir(workdir), extensions)
    lw_files.clear()
    for filename in filenames:
        lw_files.addItem(filename)


btn_dir.clicked.connect(showFilenamesList)


class ImageProcessor:
    def init(self):
        self.image = None
        self.filename = None
        self.dir = None
        self.save_dir = "Modified/"

    def loadImage(self, dir, filename):
        self.dir = dir
        self.filename = filename
        image_path = os.path.join(dir, filename)
        self.image = Image.open(image_path)

    def showImage(self):
        path = os.path.join(self.dir, self.filename)
        pixmapimage = QPixmap(path)
        w, h = lb_image.width(), lb_image.height()
        pixmapimage = pixmapimage.scaled(w, h, Qt.KeepAspectRatio)
        lb_image.setPixmap(pixmapimage)

    def saveImage(self):
        path = os.path.join(self.dir, self.save_dir)
        if not os.path.exists(path):
            os.mkdir(path)
        fullpath = os.path.join(path, self.filename)
        self.image.save(fullpath)
        self.dir = path

    def do_left(self):
        self.image = self.image.transpose(Image.ROTATE_90)
        self.saveImage()
        self.showImage()

    def do_right(self):
        self.image = self.image.transpose(Image.ROTATE_270)
        self.saveImage()
        self.showImage()

    def do_flip(self):
        self.image = ImageOps.mirror(self.image)
        self.saveImage()
        self.showImage()

    def do_sharp(self):
        self.image = self.image.filter(ImageFilter.SHARPEN)
        self.saveImage()
        self.showImage()

    def do_bw(self):
        self.image = ImageOps.grayscale(self.image)
        self.saveImage()
        self.showImage()


workimage = ImageProcessor()


def showChosenImage():
    if lw_files.currentItem():
        filename = lw_files.currentItem().text()
        workimage.loadImage(workdir, filename)
        workimage.showImage()


lw_files.currentRowChanged.connect(showChosenImage)
btn_left.clicked.connect(workimage.do_left)
btn_right.clicked.connect(workimage.do_right)
btn_flip.clicked.connect(workimage.do_flip)
btn_sharp.clicked.connect(workimage.do_sharp)
btn_bw.clicked.connect(workimage.do_bw)

app.exec_()
